name: Deploy to EKS

on:
  push:
    branches:
      - master  # Change this to your main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2  # Replace with your AWS region

      - name: Update Kubeconfig
        run: aws eks --region us-west-2 update-kubeconfig --name sanjay_poc_cluster  # Replace with your EKS cluster name

      - name: Get Latest ECR Image Tag
        id: get_image_tag
        run: echo "::set-output name=tag::$(aws ecr describe-images --repository-name pocrepo --region us-west-2 --query 'images|sort_by(@, &imagePushedAt)|[-1].imageTags[0]' --output text)"

      - name: Update Image Tag in Deployment
        run: sed -i "s|image:.*|image: 861596913187.dkr.ecr.us-east-1.amazonaws.com/pocrepo:latest:${{ steps.get_image_tag.outputs.tag }}|" deployment.yaml

      - name: Deploy to EKS
        run: kubectl apply -f deployment.yaml
